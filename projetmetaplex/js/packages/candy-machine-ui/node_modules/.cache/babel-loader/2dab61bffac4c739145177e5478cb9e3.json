{"ast":null,"code":"import camelCase from \"camelcase\";\nimport EventEmitter from \"eventemitter3\";\nimport * as bs58 from \"bs58\";\nimport { SystemProgram } from \"@solana/web3.js\";\nimport Coder, { ACCOUNT_DISCRIMINATOR_SIZE, accountSize, AccountsCoder } from \"../../coder\";\nimport { translateAddress } from \"../common\";\nimport { getProvider } from \"../../\";\nimport * as pubkeyUtil from \"../../utils/pubkey\";\nimport * as rpcUtil from \"../../utils/rpc\";\nexport default class AccountFactory {\n  static build(idl, coder, programId, provider) {\n    var _a;\n\n    const accountFns = {};\n    (_a = idl.accounts) === null || _a === void 0 ? void 0 : _a.forEach(idlAccount => {\n      const name = camelCase(idlAccount.name);\n      accountFns[name] = new AccountClient(idl, idlAccount, programId, provider, coder);\n    });\n    return accountFns;\n  }\n\n}\nexport class AccountClient {\n  constructor(idl, idlAccount, programId, provider, coder) {\n    var _a;\n\n    this._idlAccount = idlAccount;\n    this._programId = programId;\n    this._provider = provider !== null && provider !== void 0 ? provider : getProvider();\n    this._coder = coder !== null && coder !== void 0 ? coder : new Coder(idl);\n    this._size = ACCOUNT_DISCRIMINATOR_SIZE + ((_a = accountSize(idl, idlAccount)) !== null && _a !== void 0 ? _a : 0);\n  }\n  /**\n   * Returns the number of bytes in this account.\n   */\n\n\n  get size() {\n    return this._size;\n  }\n  /**\n   * Returns the program ID owning all accounts.\n   */\n\n\n  get programId() {\n    return this._programId;\n  }\n  /**\n   * Returns the client's wallet and network provider.\n   */\n\n\n  get provider() {\n    return this._provider;\n  }\n  /**\n   * Returns the coder.\n   */\n\n\n  get coder() {\n    return this._coder;\n  }\n  /**\n   * Returns a deserialized account, returning null if it doesn't exist.\n   *\n   * @param address The address of the account to fetch.\n   */\n\n\n  async fetchNullable(address) {\n    const accountInfo = await this._provider.connection.getAccountInfo(translateAddress(address));\n\n    if (accountInfo === null) {\n      return null;\n    } // Assert the account discriminator is correct.\n\n\n    const discriminator = AccountsCoder.accountDiscriminator(this._idlAccount.name);\n\n    if (discriminator.compare(accountInfo.data.slice(0, 8))) {\n      throw new Error(\"Invalid account discriminator\");\n    }\n\n    return this._coder.accounts.decode(this._idlAccount.name, accountInfo.data);\n  }\n  /**\n   * Returns a deserialized account.\n   *\n   * @param address The address of the account to fetch.\n   */\n\n\n  async fetch(address) {\n    const data = await this.fetchNullable(address);\n\n    if (data === null) {\n      throw new Error(`Account does not exist ${address.toString()}`);\n    }\n\n    return data;\n  }\n  /**\n   * Returns multiple deserialized accounts.\n   * Accounts not found or with wrong discriminator are returned as null.\n   *\n   * @param addresses The addresses of the accounts to fetch.\n   */\n\n\n  async fetchMultiple(addresses) {\n    const accounts = await rpcUtil.getMultipleAccounts(this._provider.connection, addresses.map(address => translateAddress(address)));\n    const discriminator = AccountsCoder.accountDiscriminator(this._idlAccount.name); // Decode accounts where discriminator is correct, null otherwise\n\n    return accounts.map(account => {\n      if (account == null) {\n        return null;\n      }\n\n      if (discriminator.compare(account === null || account === void 0 ? void 0 : account.account.data.slice(0, 8))) {\n        return null;\n      }\n\n      return this._coder.accounts.decode(this._idlAccount.name, account === null || account === void 0 ? void 0 : account.account.data);\n    });\n  }\n  /**\n   * Returns all instances of this account type for the program.\n   *\n   * @param filters User-provided filters to narrow the results from `connection.getProgramAccounts`.\n   *\n   *                When filters are not defined this method returns all\n   *                the account instances.\n   *\n   *                When filters are of type `Buffer`, the filters are appended\n   *                after the discriminator.\n   *\n   *                When filters are of type `GetProgramAccountsFilter[]`,\n   *                filters are appended after the discriminator filter.\n   */\n\n\n  async all(filters) {\n    const discriminator = AccountsCoder.accountDiscriminator(this._idlAccount.name);\n    let resp = await this._provider.connection.getProgramAccounts(this._programId, {\n      commitment: this._provider.connection.commitment,\n      filters: [{\n        memcmp: {\n          offset: 0,\n          bytes: bs58.encode(filters instanceof Buffer ? Buffer.concat([discriminator, filters]) : discriminator)\n        }\n      }, ...(Array.isArray(filters) ? filters : [])]\n    });\n    return resp.map(_ref => {\n      let {\n        pubkey,\n        account\n      } = _ref;\n      return {\n        publicKey: pubkey,\n        account: this._coder.accounts.decode(this._idlAccount.name, account.data)\n      };\n    });\n  }\n  /**\n   * Returns an `EventEmitter` emitting a \"change\" event whenever the account\n   * changes.\n   */\n\n\n  subscribe(address, commitment) {\n    const sub = subscriptions.get(address.toString());\n\n    if (sub) {\n      return sub.ee;\n    }\n\n    const ee = new EventEmitter();\n    address = translateAddress(address);\n\n    const listener = this._provider.connection.onAccountChange(address, acc => {\n      const account = this._coder.accounts.decode(this._idlAccount.name, acc.data);\n\n      ee.emit(\"change\", account);\n    }, commitment);\n\n    subscriptions.set(address.toString(), {\n      ee,\n      listener\n    });\n    return ee;\n  }\n  /**\n   * Unsubscribes from the account at the given address.\n   */\n\n\n  async unsubscribe(address) {\n    let sub = subscriptions.get(address.toString());\n\n    if (!sub) {\n      console.warn(\"Address is not subscribed\");\n      return;\n    }\n\n    if (subscriptions) {\n      await this._provider.connection.removeAccountChangeListener(sub.listener).then(() => {\n        subscriptions.delete(address.toString());\n      }).catch(console.error);\n    }\n  }\n  /**\n   * Returns an instruction for creating this account.\n   */\n\n\n  async createInstruction(signer, sizeOverride) {\n    const size = this.size;\n    return SystemProgram.createAccount({\n      fromPubkey: this._provider.wallet.publicKey,\n      newAccountPubkey: signer.publicKey,\n      space: sizeOverride !== null && sizeOverride !== void 0 ? sizeOverride : size,\n      lamports: await this._provider.connection.getMinimumBalanceForRentExemption(sizeOverride !== null && sizeOverride !== void 0 ? sizeOverride : size),\n      programId: this._programId\n    });\n  }\n  /**\n   * @deprecated since version 14.0.\n   *\n   * Function returning the associated account. Args are keys to associate.\n   * Order matters.\n   */\n\n\n  async associated() {\n    const addr = await this.associatedAddress(...arguments);\n    return await this.fetch(addr);\n  }\n  /**\n   * @deprecated since version 14.0.\n   *\n   * Function returning the associated address. Args are keys to associate.\n   * Order matters.\n   */\n\n\n  async associatedAddress() {\n    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n      args[_key] = arguments[_key];\n    }\n\n    return await pubkeyUtil.associated(this._programId, ...args);\n  }\n\n} // Tracks all subscriptions.\n\nconst subscriptions = new Map();","map":{"version":3,"mappings":"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","names":["camelCase","EventEmitter","bs58","SystemProgram","Coder","ACCOUNT_DISCRIMINATOR_SIZE","accountSize","AccountsCoder","translateAddress","getProvider","pubkeyUtil","rpcUtil","AccountFactory","build","idl","coder","programId","provider","accountFns","accounts","_a","forEach","idlAccount","name","AccountClient","constructor","_idlAccount","_programId","_provider","_coder","_size","size","fetchNullable","address","accountInfo","connection","getAccountInfo","discriminator","accountDiscriminator","compare","data","slice","Error","decode","fetch","toString","fetchMultiple","addresses","getMultipleAccounts","map","account","all","filters","resp","getProgramAccounts","commitment","memcmp","offset","bytes","encode","Buffer","concat","Array","isArray","pubkey","publicKey","subscribe","sub","subscriptions","get","ee","listener","onAccountChange","acc","emit","set","unsubscribe","console","warn","removeAccountChangeListener","then","delete","catch","error","createInstruction","signer","sizeOverride","createAccount","fromPubkey","wallet","newAccountPubkey","space","lamports","getMinimumBalanceForRentExemption","associated","addr","associatedAddress","args","Map"],"sourceRoot":"","sources":["../../../../src/program/namespace/account.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}